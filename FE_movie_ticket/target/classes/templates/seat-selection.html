<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/header :: header}"></head>

<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<main class="container">
    <!-- Movie Info Header -->
    <div class="movie-detail-header" style="margin-bottom: 40px;">
        <div class="poster-column">
            <img th:src="${movie.posterUrl}" th:alt="${movie.title}" style="width: 100%; border-radius: 10px;">
        </div>
        <div class="info-column">
            <h1 th:text="${movie.title}" style="margin-bottom: 15px;"></h1>
            <div class="meta-info">
                <span th:text="${movie.genre}"></span>
                <span th:text="${movie.durationMin} + ' phút'"></span>
                <span class="rating" th:text="${movie.rating}"></span>
            </div>
            <div style="margin-top: 20px; color: var(--color-text-secondary);">
                <i class="fas fa-clock"></i> Xuất chiếu: 18:30 - Rạp 3 - CGV Vincom Center
            </div>
        </div>
    </div>

    <!-- Seat Selection Section -->
    <div class="seat-booking-layout">
        <!-- Left Panel - Cinema Hall -->
        <div class="cinema-hall-panel">
            <h2 class="section-title" style="margin-bottom: 30px;">
                <i class="fas fa-tv"></i> Chọn ghế
            </h2>
            
            <!-- Screen -->
            <div class="screen-area" style="text-align: center; margin-bottom: 40px;">
                <div class="cinema-screen">MÀN HÌNH</div>
            </div>

            <!-- Seat Map -->
            <div class="seat-map" id="seatMap">
                <!-- Standard Rows (closer to screen) -->
                <div class="seat-section">
                    <div class="section-label">STANDARD - 95.000đ</div>
                    <div class="seat-row" data-row="A">
                        <span class="row-label">A</span>
                        <div class="seats">
                            <div class="seat standard available" data-seat="A1" data-price="95000">1</div>
                            <div class="seat standard available" data-seat="A2" data-price="95000">2</div>
                            <div class="seat standard available" data-seat="A3" data-price="95000">3</div>
                            <div class="seat standard available" data-seat="A4" data-price="95000">4</div>
                            <div class="seat standard available" data-seat="A5" data-price="95000">5</div>
                            <div class="seat standard available" data-seat="A6" data-price="95000">6</div>
                            <div class="seat standard available" data-seat="A7" data-price="95000">7</div>
                            <div class="seat standard available" data-seat="A8" data-price="95000">8</div>
                            <div class="seat standard available" data-seat="A9" data-price="95000">9</div>
                            <div class="seat standard available" data-seat="A10" data-price="95000">10</div>
                        </div>
                    </div>
                    <div class="seat-row" data-row="B">
                        <span class="row-label">B</span>
                        <div class="seats">
                            <div class="seat standard available" data-seat="B1" data-price="95000">1</div>
                            <div class="seat standard available" data-seat="B2" data-price="95000">2</div>
                            <div class="seat standard occupied" data-seat="B3" data-price="95000">3</div>
                            <div class="seat standard occupied" data-seat="B4" data-price="95000">4</div>
                            <div class="seat standard available" data-seat="B5" data-price="95000">5</div>
                            <div class="seat standard available" data-seat="B6" data-price="95000">6</div>
                            <div class="seat standard available" data-seat="B7" data-price="95000">7</div>
                            <div class="seat standard available" data-seat="B8" data-price="95000">8</div>
                            <div class="seat standard available" data-seat="B9" data-price="95000">9</div>
                            <div class="seat standard available" data-seat="B10" data-price="95000">10</div>
                        </div>
                    </div>
                    <div class="seat-row" data-row="C">
                        <span class="row-label">C</span>
                        <div class="seats">
                            <div class="seat standard available" data-seat="C1" data-price="95000">1</div>
                            <div class="seat standard available" data-seat="C2" data-price="95000">2</div>
                            <div class="seat standard available" data-seat="C3" data-price="95000">3</div>
                            <div class="seat standard available" data-seat="C4" data-price="95000">4</div>
                            <div class="seat standard available" data-seat="C5" data-price="95000">5</div>
                            <div class="seat standard available" data-seat="C6" data-price="95000">6</div>
                            <div class="seat standard available" data-seat="C7" data-price="95000">7</div>
                            <div class="seat standard available" data-seat="C8" data-price="95000">8</div>
                            <div class="seat standard available" data-seat="C9" data-price="95000">9</div>
                            <div class="seat standard available" data-seat="C10" data-price="95000">10</div>
                        </div>
                    </div>
                </div>

                <!-- VIP Rows (sweet spot) -->
                <div class="seat-section vip-section" style="margin: 30px 0;">
                    <div class="section-label">VIP - 150.000đ</div>
                    <div class="seat-row" data-row="D">
                        <span class="row-label">D</span>
                        <div class="seats">
                            <div class="seat vip available" data-seat="D1" data-price="150000">1</div>
                            <div class="seat vip available" data-seat="D2" data-price="150000">2</div>
                            <div class="seat vip available" data-seat="D3" data-price="150000">3</div>
                            <div class="seat vip available" data-seat="D4" data-price="150000">4</div>
                            <div class="seat vip available" data-seat="D5" data-price="150000">5</div>
                            <div class="seat vip available" data-seat="D6" data-price="150000">6</div>
                            <div class="seat vip available" data-seat="D7" data-price="150000">7</div>
                            <div class="seat vip available" data-seat="D8" data-price="150000">8</div>
                        </div>
                    </div>
                    <div class="seat-row" data-row="E">
                        <span class="row-label">E</span>
                        <div class="seats">
                            <div class="seat vip available" data-seat="E1" data-price="150000">1</div>
                            <div class="seat vip available" data-seat="E2" data-price="150000">2</div>
                            <div class="seat vip occupied" data-seat="E3" data-price="150000">3</div>
                            <div class="seat vip available" data-seat="E4" data-price="150000">4</div>
                            <div class="seat vip available" data-seat="E5" data-price="150000">5</div>
                            <div class="seat vip available" data-seat="E6" data-price="150000">6</div>
                            <div class="seat vip available" data-seat="E7" data-price="150000">7</div>
                            <div class="seat vip available" data-seat="E8" data-price="150000">8</div>
                        </div>
                    </div>
                </div>

                <!-- Couple Seats -->
                <div class="seat-section couple-section">
                    <div class="section-label">COUPLE - 280.000đ/cặp</div>
                    <div class="seat-row" data-row="F">
                        <span class="row-label">F</span>
                        <div class="seats">
                            <div class="seat couple available" data-seat="F1-F2" data-price="280000">1-2</div>
                            <div class="seat couple available" data-seat="F3-F4" data-price="280000">3-4</div>
                            <div class="seat couple available" data-seat="F5-F6" data-price="280000">5-6</div>
                            <div class="seat couple available" data-seat="F7-F8" data-price="280000">7-8</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seat Legend -->
            <div class="seat-legend">
                <div class="legend-item">
                    <div class="seat standard available demo"></div>
                    <span>Ghế trống</span>
                </div>
                <div class="legend-item">
                    <div class="seat standard selected demo"></div>
                    <span>Ghế đang chọn</span>
                </div>
                <div class="legend-item">
                    <div class="seat standard occupied demo"></div>
                    <span>Ghế đã bán</span>
                </div>
                <div class="legend-item">
                    <div class="seat vip available demo"></div>
                    <span>Ghế VIP</span>
                </div>
                <div class="legend-item">
                    <div class="seat couple available demo"></div>
                    <span>Ghế Couple</span>
                </div>
            </div>
        </div>

        <!-- Right Panel - Booking Summary -->
        <div class="booking-sidebar">
            <div class="booking-card">
                <h3><i class="fas fa-shopping-cart"></i> Chi tiết đặt vé</h3>
                
                <!-- Selected Seats -->
                <div class="booking-section">
                    <h4><i class="fas fa-chair"></i> Ghế đã chọn</h4>
                    <div id="selectedSeats" class="selected-seats-list">
                        <div class="empty-selection">
                            <i class="fas fa-info-circle"></i>
                            <span>Chưa chọn ghế nào</span>
                        </div>
                    </div>
                </div>

                <!-- Next Step Info -->
                <div class="booking-section">
                    <h4><i class="fas fa-arrow-right"></i> Bước tiếp theo</h4>
                    <div class="next-step-info">
                        <div class="step-item">
                            <i class="fas fa-utensils"></i>
                            <div>
                                <strong>Chọn đồ ăn & thức uống</strong>
                                <p>Bắp rang, nước uống, combo tiết kiệm</p>
                            </div>
                        </div>
                        <div class="step-item">
                            <i class="fas fa-credit-card"></i>
                            <div>
                                <strong>Thanh toán</strong>
                                <p>Xác nhận và thanh toán đơn hàng</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="booking-section order-summary">
                    <div class="summary-row total">
                        <span><strong>Tổng tiền vé:</strong></span>
                        <span id="ticketTotal" class="price"><strong>0đ</strong></span>
                    </div>
                    <div class="summary-note">
                        <i class="fas fa-info-circle"></i>
                        <small>Giá đồ ăn sẽ được tính ở bước tiếp theo</small>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button type="button" class="btn btn-secondary" onclick="history.back()">
                        <i class="fas fa-arrow-left"></i> Quay lại
                    </button>
                    <button type="button" class="btn btn-primary" id="continueBtn" disabled>
                        <i class="fas fa-utensils"></i> Chọn đồ ăn
                    </button>
                </div>
            </div>
        </div>
    </div>
</main>

<div th:replace="~{fragments/footer :: footer}"></div>

<style>
/* Seat Selection Styles - Following Dark Theme */
.seat-booking-layout {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 40px;
    margin-top: 30px;
}

.cinema-hall-panel {
    background-color: var(--color-surface);
    border-radius: 8px;
    padding: 30px;
}

.cinema-screen {
    background: linear-gradient(135deg, var(--color-primary), #c44569);
    color: white;
    padding: 15px;
    border-radius: 8px;
    font-weight: bold;
    font-size: 1.2rem;
    text-align: center;
    margin: 0 auto;
    max-width: 300px;
    box-shadow: 0 5px 15px rgba(229, 9, 20, 0.3);
}

.seat-section {
    margin-bottom: 25px;
}

.section-label {
    color: var(--color-text-secondary);
    font-weight: bold;
    margin-bottom: 15px;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.seat-row {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
    gap: 15px;
}

.row-label {
    font-weight: bold;
    color: var(--color-text-primary);
    width: 20px;
    text-align: center;
}

.seats {
    display: flex;
    gap: 6px;
}

.seat {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    position: relative;
}

.seat.standard.available {
    background-color: #444;
    color: var(--color-text-primary);
    border-color: #666;
}

.seat.standard.available:hover {
    background-color: #555;
    border-color: var(--color-primary);
    transform: translateY(-2px);
}

.seat.vip.available {
    background: linear-gradient(135deg, #f39c12, #e74c3c);
    color: white;
    border-color: #d35400;
}

.seat.vip.available:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(243, 156, 18, 0.4);
}

.seat.couple.available {
    background: linear-gradient(135deg, #e91e63, #9c27b0);
    color: white;
    width: 68px;
    border-color: #8e24aa;
}

.seat.couple.available:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(233, 30, 99, 0.4);
}

.seat.selected {
    background-color: var(--color-primary) !important;
    color: white !important;
    border-color: var(--color-primary) !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(229, 9, 20, 0.4);
}

.seat.occupied {
    background-color: #666;
    color: #999;
    cursor: not-allowed;
    opacity: 0.5;
}

.seat.demo {
    width: 20px;
    height: 20px;
    font-size: 0.6rem;
}

.seat-legend {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 30px;
    padding: 20px;
    background-color: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--color-text-secondary);
    font-size: 0.9rem;
}

.booking-sidebar {
    position: sticky;
    top: 20px;
    height: fit-content;
}

.booking-card {
    background-color: var(--color-surface);
    border-radius: 8px;
    padding: 25px;
    border: 1px solid #333;
}

.booking-card h3 {
    color: var(--color-text-primary);
    margin-bottom: 20px;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 10px;
    border-bottom: 2px solid var(--color-primary);
    padding-bottom: 10px;
}

.booking-section {
    margin-bottom: 25px;
}

.booking-section h4 {
    color: var(--color-text-secondary);
    margin-bottom: 15px;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.selected-seats-list {
    min-height: 60px;
    background-color: rgba(255, 255, 255, 0.05);
    border-radius: 6px;
    padding: 15px;
}

.empty-selection {
    text-align: center;
    color: var(--color-text-secondary);
    font-style: italic;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.selected-seat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #333;
    color: var(--color-text-primary);
}

.selected-seat-item:last-child {
    border-bottom: none;
}

.selected-seat-item .price {
    color: var(--color-primary);
    font-weight: bold;
}

.next-step-info {
    background-color: rgba(255, 255, 255, 0.05);
    border-radius: 6px;
    padding: 15px;
}

.step-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 0;
    border-bottom: 1px solid #333;
}

.step-item:last-child {
    border-bottom: none;
}

.step-item i {
    color: var(--color-primary);
    font-size: 1.2rem;
    width: 24px;
    text-align: center;
}

.step-item div {
    flex: 1;
}

.step-item strong {
    color: var(--color-text-primary);
    display: block;
    margin-bottom: 4px;
}

.step-item p {
    color: var(--color-text-secondary);
    font-size: 0.85rem;
    margin: 0;
}

.summary-note {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 10px;
    color: var(--color-text-secondary);
    font-style: italic;
}

.summary-note i {
    color: var(--color-primary);
}

.order-summary {
    background-color: rgba(255, 255, 255, 0.05);
    border-radius: 6px;
    padding: 15px;
    border: 1px solid #333;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    color: var(--color-text-secondary);
}

.summary-row.total {
    border-top: 2px solid var(--color-primary);
    padding-top: 15px;
    margin-top: 15px;
    color: var(--color-text-primary);
    font-size: 1.1rem;
}

.summary-row .price {
    color: var(--color-primary);
    font-weight: bold;
}

.action-buttons {
    display: flex;
    gap: 15px;
    margin-top: 25px;
}

.action-buttons .btn {
    flex: 1;
    padding: 12px 20px;
    border-radius: 5px;
    font-weight: bold;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    text-decoration: none;
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

@media (max-width: 992px) {
    .seat-booking-layout {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .booking-sidebar {
        position: static;
    }
    
    .movie-detail-header {
        flex-direction: column;
        text-align: center;
    }
    
    .poster-column {
        max-width: 250px;
        margin: 0 auto;
    }
}

@media (max-width: 768px) {
    .seat {
        width: 28px;
        height: 28px;
        font-size: 0.7rem;
    }
    
    .seat.couple.available {
        width: 60px;
    }
    
    .seats {
        gap: 4px;
    }
    
    .action-buttons {
        flex-direction: column;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Seat selection functionality
    const seats = document.querySelectorAll('.seat.available');
    const selectedSeatsContainer = document.getElementById('selectedSeats');
    const ticketTotalElement = document.getElementById('ticketTotal');
    const continueBtn = document.getElementById('continueBtn');
    
    let selectedSeats = []; // Start with no pre-selected seats
    
    // Initialize display
    updateSelectedSeatsDisplay();
    updateTotals();
    
    // Seat click handler - Fixed logic
    seats.forEach(seat => {
        seat.addEventListener('click', function() {
            const seatId = this.getAttribute('data-seat');
            
            if (this.classList.contains('selected')) {
                // Deselect seat - FIXED: Can now deselect
                this.classList.remove('selected');
                selectedSeats = selectedSeats.filter(s => s !== seatId);
            } else {
                // Select seat (max 8 seats)
                if (selectedSeats.length < 8) {
                    this.classList.add('selected');
                    selectedSeats.push(seatId);
                } else {
                    alert('Bạn chỉ có thể chọn tối đa 8 ghế!');
                }
            }
            
            updateSelectedSeatsDisplay();
            updateTotals();
        });
    });
    
    function updateSelectedSeatsDisplay() {
        if (selectedSeats.length === 0) {
            selectedSeatsContainer.innerHTML = `
                <div class="empty-selection">
                    <i class="fas fa-info-circle"></i>
                    <span>Chưa chọn ghế nào</span>
                </div>
            `;
        } else {
            selectedSeatsContainer.innerHTML = '';
            selectedSeats.forEach(seatId => {
                const seatElement = document.querySelector(`[data-seat="${seatId}"]`);
                if (seatElement) {
                    const seatType = seatElement.classList.contains('vip') ? 'VIP' : 
                                   seatElement.classList.contains('couple') ? 'Couple' : 'Standard';
                    const price = parseInt(seatElement.getAttribute('data-price'));
                    
                    const seatItem = document.createElement('div');
                    seatItem.className = 'selected-seat-item';
                    seatItem.innerHTML = `
                        <span>Ghế ${seatId} (${seatType})</span>
                        <span class="price">${price.toLocaleString('vi-VN')}đ</span>
                    `;
                    selectedSeatsContainer.appendChild(seatItem);
                }
            });
        }
    }
    
    function updateTotals() {
        // Calculate ticket total only
        let ticketTotal = 0;
        selectedSeats.forEach(seatId => {
            const seatElement = document.querySelector(`[data-seat="${seatId}"]`);
            if (seatElement) {
                ticketTotal += parseInt(seatElement.getAttribute('data-price'));
            }
        });
        
        // Update display
        ticketTotalElement.textContent = ticketTotal.toLocaleString('vi-VN') + 'đ';
        
        // Enable/disable continue button
        continueBtn.disabled = selectedSeats.length === 0;
    }
    
    // Continue button handler - Redirect to food selection
    continueBtn.addEventListener('click', function() {
        if (selectedSeats.length === 0) {
            alert('Vui lòng chọn ít nhất 1 ghế!');
            return;
        }
        
        // Get movie and showtime IDs
        const movieId = /*[[${movieId}]]*/ 0;
        const showtimeId = /*[[${showtimeId}]]*/ 0;
        
        // Store seat selection data in sessionStorage for next step
        const seatData = {
            movieId: movieId,
            showtimeId: showtimeId,
            seats: selectedSeats,
            ticketTotal: ticketTotalElement.textContent
        };
        
        sessionStorage.setItem('seatSelection', JSON.stringify(seatData));
        
        // Redirect to food selection page
        window.location.href = '/booking/refreshments?movieId=' + movieId + '&showtimeId=' + showtimeId;
    });
});
</script>

